language: ruby
dependencies:
  cache_directories:
    - public/assets
    - tmp/cache/assets
deploy:
  provider: heroku
  api_key:
    secure: "KvDSOs4kKgvoPQ5uRzLAuSmOcptJo7Ie2vEvnaf9b36zqKp6FA5h4fRF5EvUoW538WO/UyBqQzZjiRlCWSl2XYTDmb5AP4lZXrlYcNFcVwAcV79JI9shlH/HKff272/dxOJVtGalqiW/K5vNhLnblVmEwgORHPrudeSH6hyU/D5C7KfXIMuotzyyLO2qaYnTlMttcmYDy9jQcML0vhimNJje+XVMLrcorDTZq9DWojYdnse14gmUoB4NIyOwFUIFRdsM9JEKorWvhQ5xXhXAaajS7blKYmCaLnuMeFzDqFOT8Qdsepf2uBpu3ocQr46KqTfVdhTV9udSgbg2OQkduZMRRaws8FmAbT3JoHBsTJDb4TFREHJix1b0+7hLdDPKZZThbCWVgcbDpPb1D5BfxWcyyeBt3Je5+6vQoX97zZ4LjQ7A3N+j580TXKbnT5gGm/dLlOBJi5G+0+TOl0sKaJTOAATow83a3kHGmkgjOICU+0f/69SyO9xlqZWB0ngBMxNyqAAakSrnVps/mQ+PHOe+6Szl1JDpOc1od2/wGX0VP61puhcEphTR3jvvrYdO8KogNbcyj5OhbjC+c3SlO2O/L4MnNmanKPbuBkPaHO3dHab1BJ3Wj0wvZstqot2rv9PzrvR0V9uleUEnV9AGqdqcvuhJ6yJ8pbGyOlV593M="
  app:
    master: coderdojo-japan
  run:
    - bundle exec rails db:migrate
    - bundle exec rails db:seed
    - bundle exec rails dojos:update_db_by_yaml
    - bundle exec rails dojo_event_services:upsert
cache:
  - bundler
# TODO:before_installは次のissueが解決したら削除
# cf. https://github.com/travis-ci/travis-ci/issues/9333#issuecomment-373042916
before_install:
  - gem install bundler
before_script:
  - psql -c 'create database coderdojo_jp_test;' -U postgres
script:
  - bundle exec rake db:migrate --trace
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bundle exec rspec spec; fi
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_PULL_REQUEST_SLUG" = "coderdojo-japan/coderdojo.jp" ]; then bundle exec rspec spec; fi
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_PULL_REQUEST_SLUG" != "coderdojo-japan/coderdojo.jp" ]; then bundle exec rspec spec --tag ~@scrivito; fi
env:
  global:
    - TZ='Asia/Tokyo'
addons:
  postgresql: '9.4'
