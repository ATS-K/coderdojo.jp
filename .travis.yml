language: ruby
dependencies:
  cache_directories:
    - public/assets
    - tmp/cache/assets
deploy:
  provider: heroku
  api_key:
    secure: "AD/r0qiZVOp7z4N+TzeTB9r4zw/xTQrbskt3rB+vrzOB4kI9tQNQih2myl76FgivH5gFt6q/6as4/fas1Pjht2povedsEk80rUomVTlZrCZ3jMSChOme3/GphaeA4jauZVJYSG6UPBhG3QJ8q4IbqSp8sEmePyIt4oS0panU7I39KP5LJSNMUpSKfJGYouumankuF6SGF1ZdKptZkZLvkxcVJrKKTq1pfo+PXex2kMXmDiedcZHtjflNF8YgXfy0t2+n8mubc3Dhvc3xPJHw4e3P5nxwFEgZTbghjf0ktz9YezrXS4HA5FhFdVQKal3wPMS6OOrLuiT3xA9tWxH8MrMse9TolGBSKmnByoqeGdY03ujJ7m0apcS7jCs4gREMqetxXszNRBAfol2SOxCYDk+EoZI6CCszWch2hrVm0QfTxLMHj/McY2wiTsWoE2WfqTK9jmfZpbnY55f8BwuCrIDdtn/ww6yV3kZ7wP/cLpZiKj1FrXjqlYn4fiau7dmJ8pBWHEOyY7b/tY2uhkPkAhz6vONkrzYszEK+NS2HqK+/EtnTr7caqC1MW6BTFx8uC2raY+KF9iqspivWyz9yTcu+YrwQaq6X4fApna7xuCR8xA1bKedb6Zs2XQcDUJK8Co1jF7ACXpiDiO/RLVSTFqcPCaujwKbdClffdNNk//w="
  app:
    master: coderdojo-japan
  run:
    - bundle exec rails db:migrate
    - bundle exec rails db:seed
    - bundle exec rails dojos:update_db_by_yaml
    - bundle exec rails dojo_event_services:upsert
cache:
  - bundler
# TODO:before_installは次のissueが解決したら削除
# cf. https://github.com/travis-ci/travis-ci/issues/9333#issuecomment-373042916
before_install:
  - gem install bundler
before_script:
  - psql -c 'create database coderdojo_jp_test;' -U postgres
script:
  - bundle exec rake db:migrate --trace
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bundle exec rspec spec; fi
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_PULL_REQUEST_SLUG" = "coderdojo-japan/coderdojo.jp" ]; then bundle exec rspec spec; fi
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_PULL_REQUEST_SLUG" != "coderdojo-japan/coderdojo.jp" ]; then bundle exec rspec spec --tag ~@scrivito; fi
env:
  global:
    - TZ='Asia/Tokyo'
addons:
  postgresql: '9.4'
